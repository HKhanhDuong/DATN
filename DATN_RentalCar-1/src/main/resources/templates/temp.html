<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Insert title here</title>
</head>
<body>
<script th:inline="javascript">
document.addEventListener('DOMContentLoaded', function() {
    // Helper Functions
    const getElement = id => document.getElementById(id);
    const getValue = (id, defaultValue = '') => getElement(id)?.value?.trim() || defaultValue;
    const getText = (id, defaultValue = '') => getElement(id)?.textContent?.trim() || defaultValue;

    // Constants
    const BANK_INFO = {
        BANK_ID: "MB",
        ACCOUNT_NO: "3666116122004",
        ACCOUNT_NAME: "RENTALCAR"
    };

    // Elements
    const elements = {
        rentButton: getElement("rentButton"),
        rentModal: getElement("rentModal"),
        prepayRadio: getElement("prepay"),
        postpayRadio: getElement("postpay"),
        qrContainer: document.querySelector(".qr-code-container"),
        postpayMessage: getElement("postpayMessage")
    };

    // Payment type handlers
    function togglePaymentUI(showQR) {
        elements.qrContainer.style.display = showQR ? "block" : "none";
        elements.postpayMessage.style.display = showQR ? "none" : "block";
    }

    elements.prepayRadio?.addEventListener("change", () => togglePaymentUI(true));
    elements.postpayRadio?.addEventListener("change", () => togglePaymentUI(false));

    // Generate booking code
    function generateBookingCode(carId, accId, fullName, pickUpDateTime, hours) {
        const normalizedName = fullName
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/\s+/g, "")
            .toUpperCase();
        
        const pickUpFormatted = moment(pickUpDateTime).format("YYMMDD");
        const carIdString = String(carId).padStart(4, '0');
        const roundedHours = Math.floor(Number(hours));

        return `RC${carIdString}A${accId}${normalizedName}${pickUpFormatted}T${roundedHours}`;
    }

    // Rent button handler
    elements.rentButton?.addEventListener("click", function() {
        const logAccId = /*[[${loggedAcc != null ? loggedAcc.accountId : 0}]]*/ 0;
        const carId = /*[[${car.carId}]]*/ 0;
        
        // Validate user login
        if (getText('fullName') === 'Chưa có tên') {
            alert("Vui lòng đăng nhập để tiếp tục.");
            window.location.href = "/login";
            return;
        }

        // Collect form data
        const rentalData = {
            pickupDT: getText("pickUpDateTime"),
            returnDT: getText("returnDateTime"),
            hours: getText("totalRentalHours"),
            address: getValue("address-input")
        };

        // Validate required fields
        if (Object.values(rentalData).some(value => !value)) {
            alert("Vui lòng nhập đầy đủ thông tin trước khi tiếp tục!");
            return;
        }

        // Update modal content
        const modalData = {
            "pickupTime": rentalData.pickupDT,
            "returnTime": rentalData.returnDT,
            "rentalHours": rentalData.hours,
            "finalRentRate": getText("totalRatePrice"),
            "rentalAddress": rentalData.address,
            "promoCode": `${getText('selected-promo-code')} - ${getText('selected-promo-description')}`
        };

        Object.entries(modalData).forEach(([id, value]) => {
            getElement(id).textContent = value || 'Không có';
        });

        // Generate QR Code
        const bookingCode = generateBookingCode(
            carId,
            logAccId,
            getText('fullName'),
            new Date(`${getValue("modalPickUpDate")} ${getValue("modalPickUpTime")} GMT+07:00`),
            rentalData.hours
        );

        const amount = Number(modalData.finalRentRate.replace(/\D/g, ""));
        const qrUrl = `https://img.vietqr.io/image/${BANK_INFO.BANK_ID}-${BANK_INFO.ACCOUNT_NO}-compact2.png?amount=${amount}&addInfo=${bookingCode}&accountName=${BANK_INFO.ACCOUNT_NAME}`;

        getElement("qrImage").src = qrUrl;
        getElement("qrText").textContent = bookingCode;
    });

    // Confirm rental handler
    getElement("confirmRentButton")?.addEventListener("click", function() {
        const rentalData = {
            accountId: /*[[${loggedAcc != null ? loggedAcc.accountId : 0}]]*/ 0,
            carId: /*[[${car.carId}]]*/ 0,
            fullName: getText('fullName'),
            phoneNumber: getText('sdt'),
            pickupDateTime: getText("pickupTime"),
            returnDateTime: getText("returnTime"),
            rentalHours: getText("rentalHours"),
            rentalAddress: getText("rentalAddress"),
            promoCode: getElementById("promoCode").textContent.trim(),
            notes: getValue("notes-input"),
            finalRentRate: getText("finalRentRate"),
            paymentOption: document.querySelector('input[name="paymentOption"]:checked').value
        };

        /* try {
	        const response = await fetch('/api/rentals/confirm', {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/json'
	            },
	            body: JSON.stringify(rentalData)
	        });
	
	        if (response.ok) {
	            alert("Bạn đã xác nhận thuê xe thành công!");
	        } else {
	            alert("Có lỗi xảy ra, vui lòng thử lại.");
	        }
	    } catch (error) {
	        console.error('Lỗi khi gửi yêu cầu:', error);
	        alert("Không thể kết nối tới server, vui lòng thử lại sau.");
	    } */
	    
	 	// Log thông tin ra console
	    console.log('Car ID:', rentalData.carId);
	    console.log('Pickup DateTime:', rentalData.pickupDateTime);
	    console.log('Return DateTime:', rentalData.returnDateTime);
	    console.log('Rental Hours:', rentalData.rentalHours);
	    console.log('Rental Address:', rentalAddress);
	    console.log('Promo Code:', rentalData.promoCode);
	    console.log('Notes:', rentalData.notes);
	    console.log('Final Rent Rate:', rentalData.finalRentRate);
	    console.log('Payment Option:', rentalData.paymentOption);
	    
	    
        // Instead of API call, showing success message
        alert("Bạn đã xác nhận thuê xe thành công!");
        bootstrap.Modal.getInstance(elements.rentModal).hide();
    });
});
</script>
</body>
</html>